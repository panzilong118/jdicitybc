{"version":3,"sources":["../src/sso/sso.js"],"names":["req","res","client","host","get","refer","url","test","returnUrl","query","return_url","serviceTicket","st","autosign","platformId","console","log","post","data","then","result","code","cookieDomain","replace","header","redirect","send","msg","error"],"mappings":";;;;;;kBAAe,UAASA,GAAT,EAAaC,GAAb,EAAiBC,MAAjB,EAAyB;AACpC,OAAMC,OAAOH,IAAII,GAAJ,CAAQ,MAAR,CAAb;AACA,OAAMC,QAAQL,IAAII,GAAJ,CAAQ,SAAR,CAAd;AACA,OAAIE,MAAM,yCAAV;AACA,OAAG,WAAWC,IAAX,CAAgBJ,IAAhB,KAAuB,oBAAoBI,IAApB,CAAyBF,KAAzB,CAAvB,IAA0D,YAAYE,IAAZ,CAAiBJ,IAAjB,CAA7D,EACF;AACMG,YAAM,kDAAN;AACH;AACF,OAAME,YAAYR,IAAIS,KAAJ,CAAUC,UAA5B;AACA,OAAMC,gBAAgBX,IAAIS,KAAJ,CAAUG,EAAhC;AACA,OAAMC,WAAWb,IAAIS,KAAJ,CAAUI,QAAV,IAAoB,GAArC;AACA,OAAMC,aAAa,CAAnB;AACCC,WAAQC,GAAR,CAAY,kBAAZ,EAA+B,YAA/B,EAA4CR,SAA5C,EAAsD,iBAAtD,EAAwEG,aAAxE;AACDT,UAAOe,IAAP,CAAYX,GAAZ,EAAgB,EAACY,MAAK,EAACV,oBAAD,EAAWM,sBAAX,EAAsBH,4BAAtB,EAAoCE,kBAApC,EAAN,EAAhB,EAAsEM,IAAtE,CACG,UAACC,MAAD,EAAU;AACNL,cAAQC,GAAR,CAAY,mBAAZ,EAAgCI,MAAhC;AACD,UAAGA,OAAOC,IAAP,IAAa,GAAhB,EAAqB;AACjB;AACA,aAAIC,eAAenB,KAAKoB,OAAL,CAAa,yBAAb,EAAuC,EAAvC,CAAnB;AACAR,iBAAQC,GAAR,CAAYM,YAAZ,EAAyB,0BAAzB;AACArB,aAAIuB,MAAJ,CAAW,YAAX,EAAyBJ,OAAOF,IAAP,GAAc,+BAAd,GAA8CI,YAAvE;AACArB,aAAIwB,QAAJ,CAAajB,SAAb;AACH,OAND,MAMK;AACDP,aAAIyB,IAAJ,CAASN,OAAOO,GAAhB;AACH;AACH,IAZJ,EAaG,UAACC,KAAD,EAAS;AACN3B,UAAIyB,IAAJ,CAASE,KAAT;AACF,IAfJ;AAiBF,C","file":"sso.js","sourcesContent":["export default function(req,res,client) {\r\n    const host = req.get(\"host\");\r\n    const refer = req.get(\"referer\")\r\n    var url = \"/passport/cookie/checkStAndCreateCookie\";\r\n    if(/platform/.test(host)||/passport-platform/.test(refer) || /view-zone/.test(host)\r\n) {\r\n        url = \"/platform-passport/cookie/checkStAndCreateCookie\"\r\n    }\r\n\t  const returnUrl = req.query.return_url;\r\n  \tconst serviceTicket = req.query.st;\r\n  \tconst autosign = req.query.autosign||\"1\";\r\n  \tconst platformId = 2;\r\n    console.log(\"requerst params:\",\"returnUrl:\",returnUrl,\",serviceTicket:\",serviceTicket)\r\n  \tclient.post(url,{data:{returnUrl,platformId,serviceTicket,autosign}}).then(\r\n     \t(result)=>{\r\n          console.log(\"responese result:\",result);\r\n        \tif(result.code==\"0\") {\r\n           \t\t// res.header(\"Set-Cookie\", result.data + \";Path=/\");\r\n             var cookieDomain = host.replace(/buyer\\.|shop\\.|\\bmall\\./,\"\");\r\n             console.log(cookieDomain,\"------------------------\")\r\n             res.header(\"Set-Cookie\", result.data + \";Path=/;httpOnly=true;Domain=\"+cookieDomain);\r\n             res.redirect(returnUrl);\r\n        \t}else{\r\n           \t\tres.send(result.msg)\r\n        \t}\r\n     \t},\r\n     \t(error)=>{\r\n        \tres.send(error)\r\n     \t}\r\n    )\r\n}"]}