{"version":3,"sources":["../../components/flow/index.js"],"names":["originTmpLine","source","sourceAnchor","target","KEY_CODE","backspace","delete","left","top","right","bottom","Flow","state","selected","job","line","tmpLine","focus","panelOffset","width","height","scroll","onPanelScroll","e","scrollTop","scrollLeft","bindPanelBox","panelBox","el","getBoundingClientRect","onblur","onfocus","parentElement","addEventListener","active","type","idx","stopPropagation","props","onSelectJob","disable","setState","clearActive","actionValideDelete","allowCode","indexOf","keyCode","actionValideKeyDown","onKeyDown","onDeleteJob","onDeleteLine","onDrag","nodes","event","preventDefault","x","y","newX","newY","code","bindDrag","node","point","getPanelRange","newTmpLine","targetPosi","document","removeEventListener","rect","className","style","scale","lines","render","onDrawLine","flexible","onResize","scalePercent","transform","onMouseMove","args","offset","map","targetIdx"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * flow chart component\n *\n * usage:\n *\n * props:\n *  disable\n *  flexible\n *  scale = number  // 控制缩放尺度\n *  nodes = [{coordinate: {x, y}, input: [], output: [], ...}]\n *  lines = [{source, target}] source|target is nodes idx\n *  drawLine = true|false\n *  onResize(idx, {width, height})\n *  onDrag(idx: nodes index, {x, y})\n *  onDeleteJob(nodeIdx)\n *  onDeleteLine(lineIdx)\n *  onDrawLine(sourceIdx, targetIdx)\n *  onSelectJob(jobIdx)\n */\n\nimport React, { Component } from 'react';\n// import { KEY_CODE } from 'src/config';\nimport { stopPropagation } from './util/domEvent';\n// import './index.less';\nimport { getInRectRange } from './util/computePosition';\nimport { validFunc } from './util/validate';\nimport Line from './line';\nimport Job from './job';\nimport Axis from './Axis';\nimport { INVALID_IDX, valideIdxCheck } from './util/validateCheck';\n\nconst originTmpLine = {\n  source: null,\n  sourceAnchor: null,\n  target: {}\n};\n\nconst KEY_CODE = {\n  backspace: 8,\n  delete: 46,\n  left: 37,\n  top: 38,\n  right: 39,\n  bottom: 40\n};\n\nclass Flow extends Component {\n  state = {\n    selected: {\n      job: INVALID_IDX,\n      line: INVALID_IDX\n    },\n    tmpLine: { ...originTmpLine }\n  };\n\n  // blur|focus\n  focus = false;\n\n  // panel position of screen\n  panelOffset = {\n    left: 0,\n    top: 0,\n    width: 0,\n    height: 0\n  };\n\n  scroll = {\n    top: 0,\n    left: 0\n  };\n\n  componentWillMount() {\n    document.addEventListener('keydown', this.onKeyDown);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('keydown', this.onKeyDown);\n    this.panelBox.parentElement.removeEventListener(\n      'scroll',\n      this.onPanelScroll\n    );\n  }\n\n  onPanelScroll = e => {\n    this.scroll = {\n      top: e.target.scrollTop,\n      left: e.target.scrollLeft\n    };\n  };\n\n  get linesWithCoordinate() {\n    const { lines } = this.props;\n\n    return lines.map(({ source, target }) => ({\n      source,\n      target,\n      targetIdx: target\n    }));\n  }\n\n  getPanelRange(idx) {\n    const { nodes } = this.props;\n    const { panelOffset } = this;\n    const { width, height } = nodes[idx].width;\n    const rect = {\n      top: 0,\n      left: 0,\n      right: panelOffset.width - width,\n      bottom: panelOffset.height - height\n    };\n    return rect;\n  }\n\n  bindPanelBox = el => {\n    const panelBox = el;\n    this.panelBox = el;\n    this.panelOffset = panelBox.getBoundingClientRect();\n    panelBox.onblur = () => {\n      this.focus = false;\n    };\n    panelBox.onfocus = () => {\n      this.focus = true;\n    };\n\n    panelBox.parentElement.addEventListener('scroll', this.onPanelScroll);\n  };\n\n  // 清除现有active样式\n  active = (e, type, idx) => {\n    e.stopPropagation();\n    const { onSelectJob, disable } = this.props;\n    if (disable) return;\n\n    if (type === 'job' && valideIdxCheck(idx)) {\n      validFunc(onSelectJob, idx);\n    }\n    this.setState({ selected: { [type]: idx } });\n  };\n\n  clearActive = () => {\n    const { onSelectJob } = this.props;\n    validFunc(onSelectJob, INVALID_IDX);\n    this.setState({ selected: {} });\n  }\n\n  actionValideDelete = keyCode => {\n    const allowCode = [\n      KEY_CODE.backspace,\n      KEY_CODE.delete\n    ];\n    return this.focus && allowCode.indexOf(keyCode) >= 0;\n  };\n\n  actionValideKeyDown = keyCode => {\n    const allowCode = [\n      KEY_CODE.left,\n      KEY_CODE.top,\n      KEY_CODE.right,\n      KEY_CODE.bottom\n    ];\n    return this.focus && allowCode.indexOf(keyCode) >= 0;\n  };\n\n  // 监听删除键 & 上下左右键\n  onKeyDown = event => {\n    const {\n      onDeleteJob,\n      onDeleteLine,\n      onDrag,\n      nodes,\n      disable\n    } = this.props;\n    if (disable) return;\n\n    const {\n      selected: { job, line }\n    } = this.state;\n    if (this.actionValideDelete(event.keyCode)) {\n      if (valideIdxCheck(job)) {\n        validFunc(onDeleteJob, job);\n      }\n\n      if (valideIdxCheck(line)) {\n        validFunc(onDeleteLine, line);\n      }\n      this.setState({ selected: {} });\n    }\n    // 上下左右键\n    if (this.actionValideKeyDown(event.keyCode)) {\n      event.preventDefault();\n      const { x, y } = nodes[job];\n      let newX = x;\n      let newY = y;\n      const code = event.keyCode;\n      if (code === 37) newX--; // left\n      if (code === 38) newY--; // top\n      if (code === 39) newX++; // right\n      if (code === 40) newY++; // bottom\n\n      if (valideIdxCheck(job)) {\n        validFunc(onDrag, job, { x: newX, y: newY });\n      }\n      this.setState({ selected: { job } });\n    }\n    this.setState({ selected: {} });\n  }\n\n  bindDrag = (idx, { x, y }) => {\n    const { onDrag, nodes } = this.props;\n    const node = nodes[idx];\n    const point = {\n      x: x - node.width / 2,\n      y: y - node.height / 2\n    };\n    onDrag(idx, getInRectRange(point, this.getPanelRange(idx)));\n  };\n\n  newTmpLine = ({ source, sourceAnchor, targetPosi }) => {\n    if (!valideIdxCheck(source)) {\n      this.setState({ tmpLine: originTmpLine });\n      return;\n    }\n\n    this.setState({\n      tmpLine: {\n        source,\n        sourceAnchor,\n        targetPosi: getInRectRange(targetPosi, this.getPanelRange(0))\n      }\n    });\n  };\n\n  render() {\n    const {\n      className,\n      style,\n      scale = 100,\n      disable,\n      nodes = [],\n      lines = [],\n      render,\n      onDrawLine,\n      flexible,\n      onResize\n    } = this.props;\n    const { tmpLine, selected } = this.state;\n    const scalePercent = scale / 100;\n    return (\n      <div\n        tabIndex=\"0\"\n        style={{ transform: `scale(${scalePercent})`, ...style }}\n        className={`uc-flow-panel ${className}`}\n        onMouseMove={this.onMouseMove}\n        ref={el => el && this.bindPanelBox(el)}\n        onClick={stopPropagation(this.clearActive)}\n      >\n        <Job\n          scale={scalePercent}\n          flexible={!disable && flexible}\n          nodes={nodes}\n          render={render}\n          onResize={(...args) => flexible && validFunc(onResize, ...args)}\n          onDrag={!disable && this.bindDrag}\n          onDragLine={!disable && this.newTmpLine}\n          onDrawLine={line => !disable && validFunc(onDrawLine, line)}\n          activeIdx={selected.job}\n          onClick={(e, idx) => this.active(e, 'job', idx)}\n        />\n        <svg className=\"uc-flow\">\n          <Line\n            lines={lines}\n            nodes={nodes}\n            activeIdx={selected.line}\n            tmpLine={tmpLine}\n            offset={this.offset}\n            onClick={(e, idx) => this.active(e, 'line', idx)}\n          />\n          {!disable && <Axis x={3} y={4} />}\n        </svg>\n      </div>\n    );\n  }\n}\n\nexport default Flow;\n"]}