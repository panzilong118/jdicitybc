{"version":3,"sources":["../../components/Flow/index.js"],"names":["originTmpLine","source","sourceAnchor","target","KEY_CODE","backspace","delete","left","top","right","bottom","Flow","state","selected","job","INVALID_IDX","line","tmpLine","focus","panelOffset","width","height","scroll","onPanelScroll","e","scrollTop","scrollLeft","onKeyDown","props","onDeleteJob","onDeleteLine","onDrag","nodes","disable","actionValideDelete","event","keyCode","setState","actionValideKeyDown","preventDefault","x","y","newX","newY","code","bindPanelBox","panelBox","el","getBoundingClientRect","onblur","onfocus","parentElement","addEventListener","active","type","idx","stopPropagation","onSelectJob","clearActive","allowCode","indexOf","bindDrag","node","point","getPanelRange","newTmpLine","targetPosi","document","removeEventListener","rect","className","style","scale","lines","render","onDrawLine","flexible","onResize","scalePercent","transform","onMouseMove","args","validFunc","offset","map","targetIdx","Component"],"mappings":";;;;;;;;;;AAoBA;;;;AAEA;;AACA;;AACA;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;+eA7BA;;;;;;;;;;;;;;;;;;;;AAqBA;;;AAUA,IAAMA,gBAAgB;AACpBC,UAAQ,IADY;AAEpBC,gBAAc,IAFM;AAGpBC,UAAQ;AAHY,CAAtB;;AAMA,IAAMC,WAAW;AACfC,aAAW,CADI;AAEfC,UAAQ,EAFO;AAGfC,QAAM,EAHS;AAIfC,OAAK,EAJU;AAKfC,SAAO,EALQ;AAMfC,UAAQ;AANO,CAAjB;;IASMC,I;;;;;;;;;;;;;;kLACJC,K,GAAQ;AACNC,gBAAU;AACRC,aAAKC,0BADG;AAERC,cAAMD;AAFE,OADJ;AAKNE,4BAAcjB,aAAd;AALM,K,QASRkB,K,GAAQ,K,QAGRC,W,GAAc;AACZZ,YAAM,CADM;AAEZC,WAAK,CAFO;AAGZY,aAAO,CAHK;AAIZC,cAAQ;AAJI,K,QAOdC,M,GAAS;AACPd,WAAK,CADE;AAEPD,YAAM;AAFC,K,QAiBTgB,a,GAAgB,aAAK;AACnB,YAAKD,MAAL,GAAc;AACZd,aAAKgB,EAAErB,MAAF,CAASsB,SADF;AAEZlB,cAAMiB,EAAErB,MAAF,CAASuB;AAFH,OAAd;AAID,K,QAGDC,S,GAAY,iBAAS;AAAA,wBAOf,MAAKC,KAPU;AAAA,UAEjBC,WAFiB,eAEjBA,WAFiB;AAAA,UAGjBC,YAHiB,eAGjBA,YAHiB;AAAA,UAIjBC,MAJiB,eAIjBA,MAJiB;AAAA,UAKjBC,KALiB,eAKjBA,KALiB;AAAA,UAMjBC,OANiB,eAMjBA,OANiB;;AAQnB,UAAIA,OAAJ,EAAa;;AARM,iCAYf,MAAKrB,KAZU,CAWjBC,QAXiB;AAAA,UAWLC,GAXK,wBAWLA,GAXK;AAAA,UAWAE,IAXA,wBAWAA,IAXA;;AAanB,UAAI,MAAKkB,kBAAL,CAAwBC,MAAMC,OAA9B,CAAJ,EAA4C;AAC1C,YAAI,mCAAetB,GAAf,CAAJ,EAAyB;AACvB,mCAAUe,WAAV,EAAuBf,GAAvB;AACD;;AAED,YAAI,mCAAeE,IAAf,CAAJ,EAA0B;AACxB,mCAAUc,YAAV,EAAwBd,IAAxB;AACD;AACD,cAAKqB,QAAL,CAAc,EAAExB,UAAU,EAAZ,EAAd;AACD;AACD;AACA,UAAI,MAAKyB,mBAAL,CAAyBH,MAAMC,OAA/B,CAAJ,EAA6C;AAC3CD,cAAMI,cAAN;AAD2C,yBAE1BP,MAAMlB,GAAN,CAF0B;AAAA,YAEnC0B,CAFmC,cAEnCA,CAFmC;AAAA,YAEhCC,CAFgC,cAEhCA,CAFgC;;AAG3C,YAAIC,OAAOF,CAAX;AACA,YAAIG,OAAOF,CAAX;AACA,YAAMG,OAAOT,MAAMC,OAAnB;AACA,YAAIQ,SAAS,EAAb,EAAiBF,OAN0B,CAMlB;AACzB,YAAIE,SAAS,EAAb,EAAiBD,OAP0B,CAOlB;AACzB,YAAIC,SAAS,EAAb,EAAiBF,OAR0B,CAQlB;AACzB,YAAIE,SAAS,EAAb,EAAiBD,OAT0B,CASlB;;AAEzB,YAAI,mCAAe7B,GAAf,CAAJ,EAAyB;AACvB,mCAAUiB,MAAV,EAAkBjB,GAAlB,EAAuB,EAAE0B,GAAGE,IAAL,EAAWD,GAAGE,IAAd,EAAvB;AACD;AACD,cAAKN,QAAL,CAAc,EAAExB,UAAU,EAAEC,QAAF,EAAZ,EAAd;AACD;AACD,YAAKuB,QAAL,CAAc,EAAExB,UAAU,EAAZ,EAAd;AACD,K,QAyBDgC,Y,GAAe,cAAM;AACnB,UAAMC,WAAWC,EAAjB;AACA,YAAKD,QAAL,GAAgBC,EAAhB;AACA,YAAK5B,WAAL,GAAmB2B,SAASE,qBAAT,EAAnB;AACAF,eAASG,MAAT,GAAkB,YAAM;AACtB,cAAK/B,KAAL,GAAa,KAAb;AACD,OAFD;AAGA4B,eAASI,OAAT,GAAmB,YAAM;AACvB,cAAKhC,KAAL,GAAa,IAAb;AACD,OAFD;;AAIA4B,eAASK,aAAT,CAAuBC,gBAAvB,CAAwC,QAAxC,EAAkD,MAAK7B,aAAvD;AACD,K,QAGD8B,M,GAAS,UAAC7B,CAAD,EAAI8B,IAAJ,EAAUC,GAAV,EAAkB;AACzB/B,QAAEgC,eAAF;AADyB,yBAEQ,MAAK5B,KAFb;AAAA,UAEjB6B,WAFiB,gBAEjBA,WAFiB;AAAA,UAEJxB,OAFI,gBAEJA,OAFI;;AAGzB,UAAIA,OAAJ,EAAa;;AAEb,UAAIqB,SAAS,KAAT,IAAkB,mCAAeC,GAAf,CAAtB,EAA2C;AACzC,iCAAUE,WAAV,EAAuBF,GAAvB;AACD;AACD,YAAKlB,QAAL,CAAc,EAAExB,8BAAayC,IAAb,EAAoBC,GAApB,CAAF,EAAd;AACD,K,QAEDG,W,GAAc,YAAM;AAAA,UACVD,WADU,GACM,MAAK7B,KADX,CACV6B,WADU;;AAElB,+BAAUA,WAAV,EAAuB1C,0BAAvB;AACA,YAAKsB,QAAL,CAAc,EAAExB,UAAU,EAAZ,EAAd;AACD,K,QAEDqB,kB,GAAqB,mBAAW;AAC9B,UAAMyB,YAAY,CAChBvD,SAASC,SADO,EAEhBD,SAASE,MAFO,CAAlB;AAIA,aAAO,MAAKY,KAAL,IAAcyC,UAAUC,OAAV,CAAkBxB,OAAlB,KAA8B,CAAnD;AACD,K,QAEDE,mB,GAAsB,mBAAW;AAC/B,UAAMqB,YAAY,CAChBvD,SAASG,IADO,EAEhBH,SAASI,GAFO,EAGhBJ,SAASK,KAHO,EAIhBL,SAASM,MAJO,CAAlB;AAMA,aAAO,MAAKQ,KAAL,IAAcyC,UAAUC,OAAV,CAAkBxB,OAAlB,KAA8B,CAAnD;AACD,K,QAEDyB,Q,GAAW,UAACN,GAAD,SAAmB;AAAA,UAAXf,CAAW,SAAXA,CAAW;AAAA,UAARC,CAAQ,SAARA,CAAQ;AAAA,yBACF,MAAKb,KADH;AAAA,UACpBG,MADoB,gBACpBA,MADoB;AAAA,UACZC,KADY,gBACZA,KADY;;AAE5B,UAAM8B,OAAO9B,MAAMuB,GAAN,CAAb;AACA,UAAMQ,QAAQ;AACZvB,WAAGA,IAAIsB,KAAK1C,KAAL,GAAa,CADR;AAEZqB,WAAGA,IAAIqB,KAAKzC,MAAL,GAAc;AAFT,OAAd;AAIAU,aAAOwB,GAAP,EAAY,qCAAeQ,KAAf,EAAsB,MAAKC,aAAL,CAAmBT,GAAnB,CAAtB,CAAZ;AACD,K,QAEDU,U,GAAa,iBAA0C;AAAA,UAAvChE,MAAuC,SAAvCA,MAAuC;AAAA,UAA/BC,YAA+B,SAA/BA,YAA+B;AAAA,UAAjBgE,UAAiB,SAAjBA,UAAiB;;AACrD,UAAI,CAAC,mCAAejE,MAAf,CAAL,EAA6B;AAC3B,cAAKoC,QAAL,CAAc,EAAEpB,SAASjB,aAAX,EAAd;AACA;AACD;;AAED,YAAKqC,QAAL,CAAc;AACZpB,iBAAS;AACPhB,wBADO;AAEPC,oCAFO;AAGPgE,sBAAY,qCAAeA,UAAf,EAA2B,MAAKF,aAAL,CAAmB,CAAnB,CAA3B;AAHL;AADG,OAAd;AAOD,K;;;AA/KD;;;AAGA;;;;;yCAaqB;AACnBG,eAASf,gBAAT,CAA0B,SAA1B,EAAqC,KAAKzB,SAA1C;AACD;;;2CAEsB;AACrBwC,eAASC,mBAAT,CAA6B,SAA7B,EAAwC,KAAKzC,SAA7C;AACA,WAAKmB,QAAL,CAAcK,aAAd,CAA4BiB,mBAA5B,CACE,QADF,EAEE,KAAK7C,aAFP;AAID;;AASD;;;;kCAsDcgC,G,EAAK;AAAA,UACTvB,KADS,GACC,KAAKJ,KADN,CACTI,KADS;AAAA,UAETb,WAFS,GAEO,IAFP,CAETA,WAFS;AAAA,6BAGSa,MAAMuB,GAAN,EAAWnC,KAHpB;AAAA,UAGTA,KAHS,oBAGTA,KAHS;AAAA,UAGFC,MAHE,oBAGFA,MAHE;;AAIjB,UAAMgD,OAAO;AACX7D,aAAK,CADM;AAEXD,cAAM,CAFK;AAGXE,eAAOU,YAAYC,KAAZ,GAAoBA,KAHhB;AAIXV,gBAAQS,YAAYE,MAAZ,GAAqBA;AAJlB,OAAb;AAMA,aAAOgD,IAAP;AACD;;AAgBD;;;;6BA6DS;AAAA;;AAAA,mBAYH,KAAKzC,KAZF;AAAA,UAEL0C,SAFK,UAELA,SAFK;AAAA,UAGLC,KAHK,UAGLA,KAHK;AAAA,gCAILC,KAJK;AAAA,UAILA,KAJK,gCAIG,GAJH;AAAA,UAKLvC,OALK,UAKLA,OALK;AAAA,gCAMLD,KANK;AAAA,UAMLA,KANK,gCAMG,EANH;AAAA,gCAOLyC,KAPK;AAAA,UAOLA,KAPK,gCAOG,EAPH;AAAA,UAQLC,MARK,UAQLA,MARK;AAAA,UASLC,WATK,UASLA,UATK;AAAA,UAULC,QAVK,UAULA,QAVK;AAAA,UAWLC,SAXK,UAWLA,QAXK;AAAA,mBAauB,KAAKjE,KAb5B;AAAA,UAaCK,OAbD,UAaCA,OAbD;AAAA,UAaUJ,QAbV,UAaUA,QAbV;;AAcP,UAAMiE,eAAeN,QAAQ,GAA7B;AACA,aACE;AAAA;AAAA;AACE,oBAAS,GADX;AAEE,4BAASO,sBAAoBD,YAApB,MAAT,IAAiDP,KAAjD,CAFF;AAGE,6CAAiCD,SAHnC;AAIE,uBAAa,KAAKU,WAJpB;AAKE,eAAK;AAAA,mBAAMjC,MAAM,OAAKF,YAAL,CAAkBE,EAAlB,CAAZ;AAAA,WALP;AAME,mBAAS,+BAAgB,KAAKW,WAArB;AANX;AAQE,sCAAC,aAAD;AACE,iBAAOoB,YADT;AAEE,oBAAU,CAAC7C,OAAD,IAAY2C,QAFxB;AAGE,iBAAO5C,KAHT;AAIE,kBAAQ0C,MAJV;AAKE,oBAAU;AAAA,+CAAIO,IAAJ;AAAIA,kBAAJ;AAAA;;AAAA,mBAAaL,YAAYM,sCAAUL,SAAV,SAAuBI,IAAvB,EAAzB;AAAA,WALZ;AAME,kBAAQ,CAAChD,OAAD,IAAY,KAAK4B,QAN3B;AAOE,sBAAY,CAAC5B,OAAD,IAAY,KAAKgC,UAP/B;AAQE,sBAAY;AAAA,mBAAQ,CAAChC,OAAD,IAAY,yBAAU0C,WAAV,EAAsB3D,IAAtB,CAApB;AAAA,WARd;AASE,qBAAWH,SAASC,GATtB;AAUE,mBAAS,iBAACU,CAAD,EAAI+B,GAAJ;AAAA,mBAAY,OAAKF,MAAL,CAAY7B,CAAZ,EAAe,KAAf,EAAsB+B,GAAtB,CAAZ;AAAA;AAVX,UARF;AAoBE;AAAA;AAAA,YAAK,WAAU,cAAf;AACE,wCAAC,cAAD;AACE,mBAAOkB,KADT;AAEE,mBAAOzC,KAFT;AAGE,uBAAWnB,SAASG,IAHtB;AAIE,qBAASC,OAJX;AAKE,oBAAQ,KAAKkE,MALf;AAME,qBAAS,iBAAC3D,CAAD,EAAI+B,GAAJ;AAAA,qBAAY,OAAKF,MAAL,CAAY7B,CAAZ,EAAe,MAAf,EAAuB+B,GAAvB,CAAZ;AAAA;AANX,YADF;AASG,WAACtB,OAAD,IAAY,8BAAC,cAAD,IAAM,GAAG,CAAT,EAAY,GAAG,CAAf;AATf;AApBF,OADF;AAkCD;;;wBAnJyB;AAAA,UAChBwC,KADgB,GACN,KAAK7C,KADC,CAChB6C,KADgB;;;AAGxB,aAAOA,MAAMW,GAAN,CAAU;AAAA,YAAGnF,MAAH,SAAGA,MAAH;AAAA,YAAWE,MAAX,SAAWA,MAAX;AAAA,eAAyB;AACxCF,wBADwC;AAExCE,wBAFwC;AAGxCkF,qBAAWlF;AAH6B,SAAzB;AAAA,OAAV,CAAP;AAKD;;;;EAhGgBmF,gB;;kBA8OJ3E,I","file":"index.js","sourcesContent":["/**\n * flow chart component\n *\n * usage:\n *\n * props:\n *  disable\n *  flexible\n *  scale = number  // 控制缩放尺度\n *  nodes = [{coordinate: {x, y}, input: [], output: [], ...}]\n *  lines = [{source, target}] source|target is nodes idx\n *  drawLine = true|false\n *  onResize(idx, {width, height})\n *  onDrag(idx: nodes index, {x, y})\n *  onDeleteJob(nodeIdx)\n *  onDeleteLine(lineIdx)\n *  onDrawLine(sourceIdx, targetIdx)\n *  onSelectJob(jobIdx)\n */\n\nimport React, { Component } from 'react';\n// import { KEY_CODE } from 'src/config';\nimport { stopPropagation } from './util/domEvent';\nimport './style/index.less';\nimport { getInRectRange } from './util/computePosition';\nimport { validFunc } from './util/validate';\nimport Line from './line';\nimport Job from './job';\nimport Axis from './Axis';\nimport { INVALID_IDX, valideIdxCheck } from './util/validateCheck';\n\nconst originTmpLine = {\n  source: null,\n  sourceAnchor: null,\n  target: {}\n};\n\nconst KEY_CODE = {\n  backspace: 8,\n  delete: 46,\n  left: 37,\n  top: 38,\n  right: 39,\n  bottom: 40\n};\n\nclass Flow extends Component {\n  state = {\n    selected: {\n      job: INVALID_IDX,\n      line: INVALID_IDX\n    },\n    tmpLine: { ...originTmpLine }\n  };\n\n  // blur|focus\n  focus = false;\n\n  // panel position of screen\n  panelOffset = {\n    left: 0,\n    top: 0,\n    width: 0,\n    height: 0\n  };\n\n  scroll = {\n    top: 0,\n    left: 0\n  };\n\n  componentWillMount() {\n    document.addEventListener('keydown', this.onKeyDown);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('keydown', this.onKeyDown);\n    this.panelBox.parentElement.removeEventListener(\n      'scroll',\n      this.onPanelScroll\n    );\n  }\n\n  onPanelScroll = e => {\n    this.scroll = {\n      top: e.target.scrollTop,\n      left: e.target.scrollLeft\n    };\n  };\n\n  // 监听删除键 & 上下左右键\n  onKeyDown = event => {\n    const {\n      onDeleteJob,\n      onDeleteLine,\n      onDrag,\n      nodes,\n      disable\n    } = this.props;\n    if (disable) return;\n\n    const {\n      selected: { job, line }\n    } = this.state;\n    if (this.actionValideDelete(event.keyCode)) {\n      if (valideIdxCheck(job)) {\n        validFunc(onDeleteJob, job);\n      }\n\n      if (valideIdxCheck(line)) {\n        validFunc(onDeleteLine, line);\n      }\n      this.setState({ selected: {} });\n    }\n    // 上下左右键\n    if (this.actionValideKeyDown(event.keyCode)) {\n      event.preventDefault();\n      const { x, y } = nodes[job];\n      let newX = x;\n      let newY = y;\n      const code = event.keyCode;\n      if (code === 37) newX--; // left\n      if (code === 38) newY--; // top\n      if (code === 39) newX++; // right\n      if (code === 40) newY++; // bottom\n\n      if (valideIdxCheck(job)) {\n        validFunc(onDrag, job, { x: newX, y: newY });\n      }\n      this.setState({ selected: { job } });\n    }\n    this.setState({ selected: {} });\n  }\n\n  get linesWithCoordinate() {\n    const { lines } = this.props;\n\n    return lines.map(({ source, target }) => ({\n      source,\n      target,\n      targetIdx: target\n    }));\n  }\n\n  getPanelRange(idx) {\n    const { nodes } = this.props;\n    const { panelOffset } = this;\n    const { width, height } = nodes[idx].width;\n    const rect = {\n      top: 0,\n      left: 0,\n      right: panelOffset.width - width,\n      bottom: panelOffset.height - height\n    };\n    return rect;\n  }\n\n  bindPanelBox = el => {\n    const panelBox = el;\n    this.panelBox = el;\n    this.panelOffset = panelBox.getBoundingClientRect();\n    panelBox.onblur = () => {\n      this.focus = false;\n    };\n    panelBox.onfocus = () => {\n      this.focus = true;\n    };\n\n    panelBox.parentElement.addEventListener('scroll', this.onPanelScroll);\n  };\n\n  // 清除现有active样式\n  active = (e, type, idx) => {\n    e.stopPropagation();\n    const { onSelectJob, disable } = this.props;\n    if (disable) return;\n\n    if (type === 'job' && valideIdxCheck(idx)) {\n      validFunc(onSelectJob, idx);\n    }\n    this.setState({ selected: { [type]: idx } });\n  };\n\n  clearActive = () => {\n    const { onSelectJob } = this.props;\n    validFunc(onSelectJob, INVALID_IDX);\n    this.setState({ selected: {} });\n  }\n\n  actionValideDelete = keyCode => {\n    const allowCode = [\n      KEY_CODE.backspace,\n      KEY_CODE.delete\n    ];\n    return this.focus && allowCode.indexOf(keyCode) >= 0;\n  };\n\n  actionValideKeyDown = keyCode => {\n    const allowCode = [\n      KEY_CODE.left,\n      KEY_CODE.top,\n      KEY_CODE.right,\n      KEY_CODE.bottom\n    ];\n    return this.focus && allowCode.indexOf(keyCode) >= 0;\n  };\n\n  bindDrag = (idx, { x, y }) => {\n    const { onDrag, nodes } = this.props;\n    const node = nodes[idx];\n    const point = {\n      x: x - node.width / 2,\n      y: y - node.height / 2\n    };\n    onDrag(idx, getInRectRange(point, this.getPanelRange(idx)));\n  };\n\n  newTmpLine = ({ source, sourceAnchor, targetPosi }) => {\n    if (!valideIdxCheck(source)) {\n      this.setState({ tmpLine: originTmpLine });\n      return;\n    }\n\n    this.setState({\n      tmpLine: {\n        source,\n        sourceAnchor,\n        targetPosi: getInRectRange(targetPosi, this.getPanelRange(0))\n      }\n    });\n  };\n\n  render() {\n    const {\n      className,\n      style,\n      scale = 100,\n      disable,\n      nodes = [],\n      lines = [],\n      render,\n      onDrawLine,\n      flexible,\n      onResize\n    } = this.props;\n    const { tmpLine, selected } = this.state;\n    const scalePercent = scale / 100;\n    return (\n      <div\n        tabIndex=\"0\"\n        style={{ transform: `scale(${scalePercent})`, ...style }}\n        className={`jdic-uc-flow-panel ${className}`}\n        onMouseMove={this.onMouseMove}\n        ref={el => el && this.bindPanelBox(el)}\n        onClick={stopPropagation(this.clearActive)}\n      >\n        <Job\n          scale={scalePercent}\n          flexible={!disable && flexible}\n          nodes={nodes}\n          render={render}\n          onResize={(...args) => flexible && validFunc(onResize, ...args)}\n          onDrag={!disable && this.bindDrag}\n          onDragLine={!disable && this.newTmpLine}\n          onDrawLine={line => !disable && validFunc(onDrawLine, line)}\n          activeIdx={selected.job}\n          onClick={(e, idx) => this.active(e, 'job', idx)}\n        />\n        <svg className=\"jdic-uc-flow\">\n          <Line\n            lines={lines}\n            nodes={nodes}\n            activeIdx={selected.line}\n            tmpLine={tmpLine}\n            offset={this.offset}\n            onClick={(e, idx) => this.active(e, 'line', idx)}\n          />\n          {!disable && <Axis x={3} y={4} />}\n        </svg>\n      </div>\n    );\n  }\n}\n\nexport default Flow;\n"]}