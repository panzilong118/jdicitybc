{"version":3,"sources":["../../components/flow/job.js"],"names":["Job","restoreStyle","setState","resizeNodeIdx","state","resize","el","node","direction","onResize","props","getDistance","curDirect","cur","boxLen","dragHandler","x","point","y","id","width","height","size","setTarget","target","targetAnchor","tmpLine","onDrawLine","onDragLine","line","mouseMove","source","sourceAnchor","nodes","targetPosi","anchors","nodeIdx","canDrag","len","map","idx","key","type","top","left","colCtrl","bottom","cursor","rowCtrl","right","bottomRightCtrl","onDrag","moveable","reset","render","onClick","flexible","ext","delete","bindDrag","e","getAnchor","input","output","getFlexibleControl","scale","Component"],"mappings":"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","file":"job.js","sourcesContent":["import React from 'react';\nimport { get, debounce } from 'lodash';\nimport './style/job.less';\nimport { getTranslate, dragHandler } from './util/drag';\nimport { getAnchorOffset } from './util/computePosition';\nimport Tooltip from './util/Tooltip';\nimport { validFunc } from './util/validate';\n\nclass Job extends React.Component {\n  restoreStyle = debounce(() => {\n    // eslint-disable-next-line\n    this.setState({ resizeNodeIdx: -1 });\n  }, 1000);\n\n  state = {\n    resizeNodeIdx: -1\n  };\n\n  get dragHandler() {\n    const { scale } = this.props;\n    return dragHandler(scale);\n  }\n\n  getAnchor(anchors, { height, width }, nodeIdx, canDrag) {\n    const len = get(anchors, 'length');\n    if (!len) return;\n\n    return anchors.map(({ key, type }, idx) => {\n      const { x, y } = getAnchorOffset(idx, { height, width }, anchors);\n      return (\n        key ? <Tooltip\n          key={`anchor-${idx}`}\n          limit=\"0\"\n          title={`字段名: ${key}, 类型: ${type}`}\n          render={() => (\n            <div\n              style={{ top: y, left: x }}\n              className=\"input\"\n              ref={el => canDrag && el && this.mouseMove(el, nodeIdx, idx)}\n              onMouseEnter={() => this.setTarget(nodeIdx, idx)}\n            />\n          )}\n        /> : <div\n          style={{ top: y, left: x }}\n          key={`anchor-${idx}`}\n          className=\"input\"\n          ref={el => (\n            canDrag && el && this.mouseMove(el, nodeIdx, idx)\n          )}\n          onMouseEnter={() => this.setTarget(nodeIdx, idx)}\n        >\n        </div>\n      );\n    });\n  }\n\n  getFlexibleControl(node) {\n    const { id } = node;\n    const colCtrl = [0, '100%'].map(left => (\n      <div\n        key={`col-${id}-${left}`}\n        className=\"flexibleControl\"\n        style={{\n          left,\n          top: 0,\n          bottom: 0,\n          cursor: left && 'col-resize'\n        }}\n        ref={el => left && this.resize(el, node, 'dx')}\n      />\n    ));\n    const rowCtrl = [0, '100%'].map(top => (\n      <div\n        key={`row-${id}-${top}`}\n        className=\"flexibleControl\"\n        style={{\n          top,\n          left: 0,\n          right: 0,\n          cursor: top && 'row-resize'\n        }}\n        ref={el => top && this.resize(el, node, 'dy')}\n      />\n    ));\n    const bottomRightCtrl = (\n      <svg\n        key={`br-${id}`}\n        height=\"12\"\n        width=\"12\"\n        className=\"bottomRight\"\n        ref={el => this.resize(el, node)}\n      >\n        <polygon points=\"0,12 12,12 12,0\" />\n        Sorry, your browser does not support inline SVG.\n      </svg>\n    );\n    return [...rowCtrl, ...colCtrl, bottomRightCtrl];\n  }\n\n  resize = (el, node, direction) => {\n    const { onResize } = this.props;\n    const getDistance = (curDirect, cur, boxLen) =>\n      (direction && direction !== curDirect ? boxLen : cur);\n\n    this.dragHandler(el, point => {\n      const { x, y } = point;\n      const { id, width, height } = node;\n      const size = {\n        width: getDistance('dx', x, width),\n        height: getDistance('dy', y, height)\n      };\n      validFunc(onResize, id, size);\n      const { resizeNodeIdx } = this.state;\n      resizeNodeIdx === -1 && this.setState({ resizeNodeIdx: node.id });\n      this.restoreStyle(el);\n    });\n  };\n\n  setTarget = (target, targetAnchor) => {\n    const { tmpLine } = this;\n    if (!tmpLine) return;\n    const { onDrawLine, onDragLine } = this.props;\n    const line = {\n      ...tmpLine,\n      target,\n      targetAnchor\n    };\n    onDragLine({});\n    onDrawLine(line);\n  };\n\n  mouseMove = (el, source, sourceAnchor) => {\n    const { nodes } = this.props;\n    const { onDragLine } = this.props;\n    this.dragHandler(\n      el,\n      point => {\n        const { x, y } = nodes[source];\n        this.tmpLine = {\n          source,\n          sourceAnchor,\n          // fix anchor position offset\n          targetPosi: {\n            x: point.x + x,\n            y: point.y + y\n          }\n        };\n        onDragLine(this.tmpLine);\n      },\n      () => {\n        this.tmpLine = null;\n        onDragLine({});\n      }\n    );\n  };\n\n  bindDrag(el, { idx }) {\n    const { onDrag } = this.props;\n    if (!onDrag) return;\n    // 当鼠标移动一些距离的时候才开始处罚onDrag\n    let moveable = 0;\n    const reset = debounce(() => { moveable = 0; }, 1000);\n    this.dragHandler(el, point => {\n      moveable += 1;\n      if (moveable < 3) return;\n      onDrag(idx, point);\n      reset();\n    });\n  }\n\n  render() {\n    const { resizeNodeIdx } = this.state;\n    const {\n      nodes, render, onClick, flexible\n    } = this.props;\n    return (\n      <React.Fragment>\n        {nodes.map((node, idx) => {\n          const {\n            x, y, width, height\n          } = node;\n\n          // 错上修错 -- 需要修改成根据 nodeId 和 anchorId 来标识节点和圈圈\n          return !node.ext.delete && (\n            <span\n              key={`job-wrap-${idx}`}\n              className=\"jobWrap\"\n              ref={el => el && this.bindDrag(el, { idx })}\n              style={getTranslate({ x, y })}\n            >\n              <div\n                key={`job-${idx}`}\n                className=\"job\"\n                style={{ width, height }}\n                onClick={e => onClick(e, idx)}\n              >\n                {this.getAnchor(\n                  node.input,\n                  {\n                    width,\n                    height: 0\n                  },\n                  idx\n                )}\n                {this.getAnchor(\n                  node.output,\n                  {\n                    width,\n                    height\n                  },\n                  idx,\n                  true\n                )}\n                {flexible && this.getFlexibleControl(node)}\n                {render(node.ext, idx)}\n              </div>\n            </span>\n          );\n        })}\n      </React.Fragment>\n    );\n  }\n}\n\nexport default Job;\n"]}