{"version":3,"sources":["../../components/upload/Upload.js"],"names":["React","Upload","props","onStart","file","targetItem","nextFileList","state","fileList","concat","status","push","onChange","window","FormData","autoUpdateProgress","onSuccess","response","clearProgressTimer","JSON","parse","e","onProgress","percent","event","onError","error","handleManualRemove","upload","abort","handleRemove","info","setState","onFileDrop","dragState","type","beforeUpload","result","map","item","uid","then","saveUpload","node","renderUploadList","locale","showUploadList","listType","onPreview","showRemoveIcon","showPreviewIcon","defaultFileList","progressTimer","_","getPercent","curPercent","setInterval","onRemove","Promise","resolve","ret","removedFileList","nextProps","clearInterval","prefixCls","className","disabled","children","rcUploadProps","uploadList","dragCls","some","uploadButtonCls","uploadButton","display","Component","defaultProps","multiple","action","data","accept","supportServerRender"],"mappings":"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","file":"Upload.js","sourcesContent":["import * as React from 'react';\r\nimport RcUpload from 'rc-upload';\r\nimport classNames from 'classnames';\r\nimport uniqBy from 'lodash/uniqBy';\r\nimport LocaleReceiver from '../locale-provider/LocaleReceiver';\r\nimport defaultLocale from '../locale-provider/default';\r\nimport Dragger from './Dragger';\r\nimport UploadList from './UploadList';\r\nimport { T, fileToObject, genPercentAdd, getFileItem, removeFileItem } from './utils';\r\n\r\nexport default class Upload extends React.Component {\r\n\r\n  static defaultProps = {\r\n    prefixCls: 'jc-upload',\r\n    type: 'select',\r\n    multiple: false,\r\n    action: '',\r\n    data: {},\r\n    accept: '',\r\n    beforeUpload: T,\r\n    showUploadList: true,\r\n    listType: 'text', // or pictrue\r\n    className: '',\r\n    disabled: false,\r\n    supportServerRender: true,\r\n  };\r\n\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.state = {\r\n      fileList: props.fileList || props.defaultFileList || [],\r\n      dragState: 'drop',\r\n    };\r\n    this.progressTimer;\r\n    this.upload;\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.clearProgressTimer();\r\n  }\r\n\r\n  onStart = (file) => {\r\n    let targetItem;\r\n    let nextFileList = this.state.fileList.concat();\r\n    targetItem = fileToObject(file);\r\n    targetItem.status = 'uploading';\r\n    nextFileList.push(targetItem);\r\n    this.onChange({\r\n      file: targetItem,\r\n      fileList: nextFileList,\r\n    });\r\n    // fix ie progress\r\n    if (!window.FormData) {\r\n      this.autoUpdateProgress(0, targetItem);\r\n    }\r\n  }\r\n\r\n  autoUpdateProgress(_, file) {\r\n    const getPercent = genPercentAdd();\r\n    let curPercent = 0;\r\n    this.clearProgressTimer();\r\n    this.progressTimer = setInterval(() => {\r\n      curPercent = getPercent(curPercent);\r\n      this.onProgress({\r\n        percent: curPercent,\r\n      }, file);\r\n    }, 200);\r\n  }\r\n\r\n  onSuccess = (response, file) => {\r\n    this.clearProgressTimer();\r\n    try {\r\n      if (typeof response === 'string') {\r\n        response = JSON.parse(response);\r\n      }\r\n    } catch (e) { /* do nothing */\r\n    }\r\n    let fileList = this.state.fileList;\r\n    let targetItem = getFileItem(file, fileList);\r\n    // removed\r\n    if (!targetItem) {\r\n      return;\r\n    }\r\n    targetItem.status = 'done';\r\n    targetItem.response = response;\r\n    this.onChange({\r\n      file: { ...targetItem },\r\n      fileList,\r\n    });\r\n  }\r\n\r\n  onProgress = (e, file) => {\r\n    let fileList = this.state.fileList;\r\n    let targetItem = getFileItem(file, fileList);\r\n    // removed\r\n    if (!targetItem) {\r\n      return;\r\n    }\r\n    targetItem.percent = e.percent;\r\n    this.onChange({\r\n      event: e,\r\n      file: { ...targetItem },\r\n      fileList: this.state.fileList,\r\n    });\r\n  }\r\n\r\n  onError = (error, response, file) => {\r\n    this.clearProgressTimer();\r\n    let fileList = this.state.fileList;\r\n    let targetItem = getFileItem(file, fileList);\r\n    // removed\r\n    if (!targetItem) {\r\n      return;\r\n    }\r\n    targetItem.error = error;\r\n    targetItem.response = response;\r\n    targetItem.status = 'error';\r\n    this.onChange({\r\n      file: { ...targetItem },\r\n      fileList,\r\n    });\r\n  }\r\n\r\n  handleRemove(file) {\r\n    const { onRemove } = this.props;\r\n\r\n    Promise.resolve(typeof onRemove === 'function' ? onRemove(file) : onRemove).then(ret => {\r\n      // Prevent removing file\r\n      if (ret === false) {\r\n        return;\r\n      }\r\n\r\n      const removedFileList = removeFileItem(file, this.state.fileList);\r\n      if (removedFileList) {\r\n        this.onChange({\r\n          file,\r\n          fileList: removedFileList,\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  handleManualRemove = (file) => {\r\n    this.upload.abort(file);\r\n    file.status = 'removed'; // eslint-disable-line\r\n    this.handleRemove(file);\r\n  }\r\n\r\n  onChange = (info) => {\r\n    if (!('fileList' in this.props)) {\r\n      this.setState({ fileList: info.fileList });\r\n    }\r\n\r\n    const { onChange } = this.props;\r\n    if (onChange) {\r\n      onChange(info);\r\n    }\r\n  }\r\n\r\n  componentWillReceiveProps(nextProps) {\r\n    if ('fileList' in nextProps) {\r\n      this.setState({\r\n        fileList: nextProps.fileList || [],\r\n      });\r\n    }\r\n  }\r\n\r\n  onFileDrop = (e) => {\r\n    this.setState({\r\n      dragState: e.type,\r\n    });\r\n  }\r\n\r\n  beforeUpload = (file, fileList) => {\r\n    if (!this.props.beforeUpload) {\r\n      return true;\r\n    }\r\n    const result = this.props.beforeUpload(file, fileList);\r\n    if (result === false) {\r\n      this.onChange({\r\n        file: fileToObject(file),\r\n        fileList: uniqBy(fileList.map(fileToObject).concat(this.state.fileList),  (item) => item.uid),\r\n      });\r\n      return false;\r\n    } else if (result && result.then) {\r\n      return result;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  clearProgressTimer() {\r\n    clearInterval(this.progressTimer);\r\n  }\r\n\r\n  saveUpload = (node) => {\r\n    this.upload = node;\r\n  }\r\n\r\n  renderUploadList = (locale) => {\r\n    const { showUploadList, listType, onPreview } = this.props;\r\n    const { showRemoveIcon, showPreviewIcon } = showUploadList;\r\n    return (\r\n      <UploadList\r\n        listType={listType}\r\n        items={this.state.fileList}\r\n        onPreview={onPreview}\r\n        onRemove={this.handleManualRemove}\r\n        showRemoveIcon={showRemoveIcon}\r\n        showPreviewIcon={showPreviewIcon}\r\n        locale={{ ...locale, ...this.props.locale }}\r\n      />\r\n    );\r\n  }\r\n\r\n  render() {\r\n    const {\r\n      prefixCls = '',\r\n      className,\r\n      showUploadList,\r\n      listType,\r\n      type,\r\n      disabled,\r\n      children,\r\n    } = this.props;\r\n\r\n    const rcUploadProps = {\r\n      onStart: this.onStart,\r\n      onError: this.onError,\r\n      onProgress: this.onProgress,\r\n      onSuccess: this.onSuccess,\r\n      ...this.props,\r\n      beforeUpload: this.beforeUpload,\r\n    };\r\n\r\n    delete rcUploadProps.className;\r\n\r\n    const uploadList = showUploadList ? (\r\n      <LocaleReceiver\r\n        componentName=\"Upload\"\r\n        defaultLocale={defaultLocale.Upload}\r\n      >\r\n        {this.renderUploadList}\r\n      </LocaleReceiver>\r\n    ) : null;\r\n\r\n    if (type === 'drag') {\r\n      const dragCls = classNames(prefixCls, {\r\n        [`${prefixCls}-drag`]: true,\r\n        [`${prefixCls}-drag-uploading`]: this.state.fileList.some(file => file.status === 'uploading'),\r\n        [`${prefixCls}-drag-hover`]: this.state.dragState === 'dragover',\r\n        [`${prefixCls}-disabled`]: disabled,\r\n      });\r\n      return (\r\n        <span className={className}>\r\n          <div\r\n            className={dragCls}\r\n            onDrop={this.onFileDrop}\r\n            onDragOver={this.onFileDrop}\r\n            onDragLeave={this.onFileDrop}\r\n          >\r\n            <RcUpload {...rcUploadProps} ref={this.saveUpload} className={`${prefixCls}-btn`}>\r\n              <div className={`${prefixCls}-drag-container`}>\r\n                {children}\r\n              </div>\r\n            </RcUpload>\r\n          </div>\r\n          {uploadList}\r\n        </span>\r\n      );\r\n    }\r\n\r\n    const uploadButtonCls = classNames(prefixCls, {\r\n      [`${prefixCls}-select`]: true,\r\n      [`${prefixCls}-select-${listType}`]: true,\r\n      [`${prefixCls}-disabled`]: disabled,\r\n    });\r\n\r\n    const uploadButton = (\r\n      <div className={uploadButtonCls} style={{ display: children ? '' : 'none' }}>\r\n        <RcUpload {...rcUploadProps} ref={this.saveUpload} />\r\n      </div>\r\n    );\r\n\r\n    if (listType === 'picture-card') {\r\n      return (\r\n        <span className={className}>\r\n          {uploadList}\r\n          {uploadButton}\r\n        </span>\r\n      );\r\n    }\r\n    return (\r\n      <span className={className}>\r\n        {uploadButton}\r\n        {uploadList}\r\n      </span>\r\n    );\r\n  }\r\n}\r\n"]}